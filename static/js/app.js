// Generated by CoffeeScript 1.3.3
(function() {
  var Application;

  Application = (function() {

    function Application() {
      this.SLIDE_SPEED = 300;
      this.AGE_CHOICES = ['10-12', '13-15', '16-18', '18-25', '26-29', '30+'];
      this.PRODUCTS = ['carmine_red', 'ghost_white', 'hot_pink', 'pale_blue'];
      this.current_product = 0;
      this.current_user = null;
      this.wrapper = $('#wrapper');
      this.home();
    }

    Application.prototype.display_slide = function(slug, params, id_attr, callback) {
      var id, old_active, slide, slide_html;
      slide_html = Templates[slug](params);
      id = id_attr ? id_attr : slug;
      slide = $('<section class="slide" />').attr('id', id + '-slide').html(slide_html);
      this.wrapper.append(slide);
      this.auto_center(slide);
      if (this.active_slide) {
        old_active = this.active_slide;
        old_active.fadeOut(this.SLIDE_SPEED, function() {
          old_active.remove();
          return slide.fadeIn(this.SLIDE_SPEED);
        });
      } else {
        slide.fadeIn(this.SLIDE_SPEED);
      }
      if (callback) {
        setTimeout(function() {
          return callback();
        }, this.SLIDE_SPEED);
      }
      return this.active_slide = slide;
    };

    Application.prototype.auto_center = function(slide) {
      return slide.css({
        "margin-left": -slide.width() / 2,
        "margin-top": -slide.height() / 2
      });
    };

    Application.prototype.home = function() {
      var params,
        _this = this;
      params = {
        home_text: "Hjälp oss att betygsätta våra nya Stålex<br/>skor & ha chansen att vara en<br/><strong>vinnare av en iPod Nano ifrån Apple.</strong>",
        continue_button: new Button("Start", 'home-continue').render()
      };
      this.display_slide('home', params);
      return $('#home-continue-btn').bind('click', function() {
        return _this.user_info();
      });
    };

    Application.prototype.user_info = function() {
      var params,
        _this = this;
      params = {
        your_name_label: 'Ditt namn',
        your_email_label: 'Din e-post',
        use_facebook_pri_text: 'Använder du Facebook?',
        facebook_chooser: this.facebook_chooser('has_facebook'),
        your_age_label: 'Hur gammal är du?',
        age_chooser: this.age_chooser('your_age'),
        next_button: new Button("Nästa", 'user-info-next').render()
      };
      this.display_slide('user_info_slide', params, 'user_info_slide', function() {
        return $('#your_name').focus();
      });
      $('#user_info_form').bind('submit', function() {
        $('#user-info-next-btn').click();
        return false;
      });
      return $('#user-info-next-btn').bind('click', function() {
        var data, errors, fields;
        fields = ['your_name', 'your_email', 'has_facebook', 'your_age'];
        data = {};
        errors = [];
        _.each(fields, function(f) {
          var d;
          d = $("#" + f).val();
          data[f] = d;
          if (d === '') {
            return errors.push(f);
          }
        });
        if (errors.length) {
          alert('Vänligen fyll i namn & e-post! Fyll i dem innan du fortsätter.');
        } else {
          _this.current_user = new User(data);
          _this.question_arbesko();
        }
        return false;
      });
    };

    Application.prototype.question_arbesko = function() {
      var params, slide,
        _this = this;
      params = {
        question: 'Känner du till Arbesko?',
        yes_button: new Button("Ja", 'question-arbesko-yes', 'yes').render(),
        no_button: new Button("Nej", 'question-arbesko-no', 'no').render()
      };
      slide = this.display_slide('question_slide', params, 'question-arbesko');
      $('#question-arbesko-yes-btn').bind('click', function() {
        return _this.current_user.arbesko_question = 'yes';
      });
      $('#question-arbesko-no-btn').bind('click', function() {
        return _this.current_user.arbesko_question = 'no';
      });
      return slide.find('button.btn').bind('click', function() {
        return _this.question_stalex();
      });
    };

    Application.prototype.question_stalex = function() {
      var params, slide,
        _this = this;
      params = {
        question: 'Känner du till Stålex?',
        yes_button: new Button("Ja", 'question-stalex-yes').render(),
        no_button: new Button("Nej", 'question-stalex-no').render()
      };
      slide = this.display_slide('question_slide', params, 'question-stalex');
      $('#question-stalex-yes-btn').bind('click', function() {
        return _this.current_user.stalex_question = 'yes';
      });
      $('#question-stalex-no-btn').bind('click', function() {
        return _this.current_user.stalex_question = 'no';
      });
      return slide.find('button.btn').bind('click', function() {
        return _this.prompt_slide();
      });
    };

    Application.prototype.prompt_slide = function() {
      var params,
        _this = this;
      params = {
        heading: 'Nu ska du få se våra skor.',
        sub_heading: 'Betygsätt dom från 1-10, där 1 är sämst och 10 är bäst och du.. <strong>var ärlig!</strong>',
        continue_button: new Button('Vidare', 'begin-voting').render()
      };
      this.display_slide('prompt_slide', params);
      return $('#begin-voting-btn').bind('click', function() {
        return _this.vote_slide();
      });
    };

    Application.prototype.vote_bar = function() {
      var button_str, buttons, num;
      buttons = (function() {
        var _i, _results;
        _results = [];
        for (num = _i = 1; _i <= 10; num = ++_i) {
          _results.push("<a data-rating=\"" + num + "\">" + num + "</a>");
        }
        return _results;
      })();
      button_str = buttons.join("");
      return "<section class=\"vote-bar\">" + button_str + "</section>";
    };

    Application.prototype.store_rating = function(product, rating) {
      return this.current_user['ratings'][product] = rating;
    };

    Application.prototype.vote_slide = function() {
      var params, product;
      product = this.PRODUCTS[this.current_product];
      params = {
        product_img: "/img/products/" + product + ".png",
        product_name: product,
        vote_bar: this.vote_bar()
      };
      this.display_slide('vote_slide', params);
      return $('#vote_slide-slide .vote-bar a').bind('click', function() {
        var rating, vote_notice;
        rating = $(this).data('rating');
        if (!$(this).hasClass('selected')) {
          if (!$('.vote-notice').size()) {
            vote_notice = $('<p class="vote-notice">Tryck en gång till på samma betyg för att fortsätta.</p>');
            $('.vote-bar').after(vote_notice);
            vote_notice.fadeIn();
          }
          $(this).siblings().removeClass('selected');
          return $(this).addClass('selected');
        } else {
          app.store_rating(product, rating);
          app.current_product++;
          if (app.current_product !== app.PRODUCTS.length) {
            return app.vote_slide();
          } else {
            app.current_product = 0;
            return app.success_slide();
          }
        }
      });
    };

    Application.prototype.success_slide = function() {
      var ipod_nanos, params, success_message, u,
        _this = this;
      u = this.current_user;
      $.ajax({
        url: '/capture',
        type: 'POST',
        dataType: 'json',
        data: u.get_serialized()
      });
      success_message = ['Tack! Nu har du en chans att vinna en iPod Nano.', "Vi har skickat e-post till " + u.email + " med mer information om tävlingen.", '<strong>Vinnaren presenteras på facebook.com/stalexshoes</strong>'];
      params = {
        success_message: success_message.join("<br/>"),
        start_over_button: new Button('Starta igen', 'reset').render()
      };
      this.display_slide('success_slide', params);
      ipod_nanos = $('<i class="ipod-nanos"></i>');
      this.wrapper.prepend(ipod_nanos);
      setTimeout(function() {
        return ipod_nanos.fadeIn(this.SLIDE_SPEED);
      }, 500);
      return $('#reset-btn').bind('click', function() {
        ipod_nanos.fadeOut(_this.SLIDE_SPEED, function() {
          return $(this).remove();
        });
        return _this.reset();
      });
    };

    Application.prototype.reset = function() {
      if (this.current_user) {
        this.current_user = false;
      }
      this.home();
    };

    Application.prototype.age_chooser = function(slug) {
      var r, x, _i, _len, _ref;
      r = ["<select id=\"" + slug + "\" name=\"" + slug + "\">"];
      _ref = this.AGE_CHOICES;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        x = _ref[_i];
        r.push("<option value=\"" + x + "\">" + x + "</option>");
      }
      r.push('</select>');
      return r.join("");
    };

    Application.prototype.facebook_chooser = function(slug) {
      var label, options, r, value;
      options = {
        yes: 'Ja',
        no: 'Nej'
      };
      r = ["<select id=\"" + slug + "\" name=\"" + slug + "\">"];
      for (value in options) {
        label = options[value];
        r.push("<option value=\"" + value + "\">" + label + "</option>");
      }
      r.push('</select>');
      return r.join("");
    };

    return Application;

  })();

  $(function() {
    return window.app = new Application;
  });

}).call(this);
